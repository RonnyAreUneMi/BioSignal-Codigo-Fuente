<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioSignal - Dashboard</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.44.0/apexcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
            color: #fff;
        }

        .header p {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 20px;
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(76, 175, 80, 0.3);
            color: white;
            border-radius: 25px;
            font-weight: 600;
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .connection-status.disconnected {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .status-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .status-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #64b5f6;
        }

        .status-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: #fff;
        }

        .status-label {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chart-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title i {
            color: #64b5f6;
        }

        .full-width-chart {
            grid-column: 1 / -1;
        }

        .statistics-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .stat-item:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.15);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #64b5f6;
        }

        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .events-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .events-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .events-table th,
        .events-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .events-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }

        .events-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .event-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .event-inicio {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .event-fin {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .status-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-seedling"></i>BioSignal/h1>
            <p>Monitoreo y Control Inteligente de Cultivos</p>
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-wifi"></i>
                <span>Conectando...</span>
            </div>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <div class="status-icon"><i class="fas fa-tint"></i></div>
                <div class="status-value" id="humidityValue">--</div>
                <div class="status-label">Humedad del Suelo</div>
            </div>
            
            <div class="status-card">
                <div class="status-icon"><i class="fas fa-thermometer-half"></i></div>
                <div class="status-value" id="temperatureValue">--</div>
                <div class="status-label">Temperatura</div>
            </div>
            
            <div class="status-card">
                <div class="status-icon"><i class="fas fa-pump-soap"></i></div>
                <div class="status-value" id="pumpStatus">--</div>
                <div class="status-label">Estado de Bomba</div>
            </div>
            
            <div class="status-card">
                <div class="status-icon"><i class="fas fa-cogs"></i></div>
                <div class="status-value" id="systemStatus">--</div>
                <div class="status-label">Estado del Sistema</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-tint"></i>
                    Evolución de Humedad del Suelo
                </div>
                <div id="humidityChart"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-thermometer-half"></i>
                    Evolución de Temperatura
                </div>
                <div id="temperatureChart"></div>
            </div>

            <div class="chart-container full-width-chart">
                <div class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    Vista General del Sistema
                </div>
                <div id="overviewChart"></div>
            </div>
        </div>

        <div class="statistics-section">
            <div class="chart-title">
                <i class="fas fa-chart-bar"></i>
                Estadísticas del Sistema
            </div>
            <div class="statistics-grid">
                <div class="stat-item">
                    <div class="stat-value" id="avgHumidity">--</div>
                    <div class="stat-label">Humedad Promedio</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="minHumidity">--</div>
                    <div class="stat-label">Humedad Mínima</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="maxHumidity">--</div>
                    <div class="stat-label">Humedad Máxima</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgTemperature">--</div>
                    <div class="stat-label">Temperatura Promedio</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="pumpActivations">--</div>
                    <div class="stat-label">Activaciones Bomba (24h)</div>
                </div>
            </div>
        </div>

        <div class="events-section">
            <div class="chart-title">
                <i class="fas fa-history"></i>
                Registro de Eventos de Riego BioSignal Pro
            </div>
            <div style="overflow-x: auto;">
                <table class="events-table">
                    <thead>
                        <tr>
                            <th>Fecha y Hora</th>
                            <th>Tipo de Evento</th>
                            <th>Humedad Antes</th>
                            <th>Humedad Después</th>
                            <th>Duración</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 30px;">
                                Cargando eventos...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let socket;
        let charts = {};
        let dataHistory = [];
        const MAX_DATA_POINTS = 50;

        // Configurar zona horaria de Ecuador (UTC-5)
        const ECUADOR_TIMEZONE_OFFSET = -5; // UTC-5

        // Función para convertir timestamp UTC a hora local de Ecuador
        function convertToEcuadorTime(timestamp) {
            const date = new Date(timestamp);
            // Si el timestamp ya viene como string, parsearlo primero
            if (typeof timestamp === 'string') {
                // Verificar si ya incluye información de zona horaria
                if (timestamp.includes('Z') || timestamp.includes('+') || timestamp.includes('-')) {
                    return new Date(timestamp);
                } else {
                    // Asumir que es UTC y convertir a hora de Ecuador
                    return new Date(timestamp + 'Z');
                }
            }
            return date;
        }

        // Función para formatear fecha en zona horaria de Ecuador
        function formatEcuadorDateTime(timestamp) {
            const date = convertToEcuadorTime(timestamp);
            return date.toLocaleString('es-EC', {
                timeZone: 'America/Guayaquil',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeCharts();
            loadHistoricalData();
            loadStatistics();
            loadEvents();
            
            setInterval(() => {
                loadHistoricalData();
                loadStatistics();
                loadEvents();
            }, 30000);
        });

        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                updateConnectionStatus(true, 'Conectado en tiempo real');
            });
            
            socket.on('disconnect', function() {
                updateConnectionStatus(false, 'Desconectado');
            });
            
            socket.on('sensor_data', function(data) {
                updateRealTimeData(data);
                addToDataHistory(data);
                updateCharts();
            });
        }

        function updateConnectionStatus(connected, message) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = connected ? 'connection-status' : 'connection-status disconnected';
            statusElement.innerHTML = `
                <i class="fas ${connected ? 'fa-wifi' : 'fa-wifi-slash'}"></i>
                <span>${message}</span>
            `;
        }

        function updateRealTimeData(data) {
            document.getElementById('humidityValue').textContent = data.humidity + '%';
            document.getElementById('temperatureValue').textContent = data.temperature + '°C';
            document.getElementById('pumpStatus').textContent = data.pump_status ? 'ACTIVA' : 'INACTIVA';
            document.getElementById('systemStatus').textContent = data.system_status;
            
            const pumpCard = document.querySelectorAll('.status-card')[2];
            if (data.pump_status) {
                pumpCard.classList.add('pulse');
            } else {
                pumpCard.classList.remove('pulse');
            }
        }

        function addToDataHistory(data) {
            dataHistory.push({
                timestamp: convertToEcuadorTime(data.timestamp),
                humidity: data.humidity,
                temperature: data.temperature,
                pump_status: data.pump_status ? 1 : 0
            });
            
            if (dataHistory.length > MAX_DATA_POINTS) {
                dataHistory.shift();
            }
        }

        function initializeCharts() {
            const chartOptions = {
                chart: {
                    background: 'transparent',
                    toolbar: { show: false },
                    locales: [{
                        name: 'es',
                        options: {
                            months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                            shortMonths: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                            days: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
                            shortDays: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb']
                        }
                    }],
                    defaultLocale: 'es'
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        format: 'HH:mm',
                        style: { colors: '#fff' },
                        datetimeUTC: false // Importante: usar hora local
                    }
                },
                grid: { borderColor: 'rgba(255,255,255,0.1)' },
                theme: { mode: 'dark' }
            };

            charts.humidity = new ApexCharts(document.querySelector("#humidityChart"), {
                ...chartOptions,
                chart: { ...chartOptions.chart, type: 'line', height: 350 },
                series: [{ name: 'Humedad (%)', data: [] }],
                yaxis: {
                    title: { text: 'Humedad (%)', style: { color: '#fff' } },
                    labels: { style: { colors: '#fff' } },
                    min: 0,
                    max: 100
                },
                colors: ['#64b5f6'],
                stroke: { curve: 'smooth', width: 3 }
            });

            charts.temperature = new ApexCharts(document.querySelector("#temperatureChart"), {
                ...chartOptions,
                chart: { ...chartOptions.chart, type: 'line', height: 350 },
                series: [{ name: 'Temperatura (°C)', data: [] }],
                yaxis: {
                    title: { text: 'Temperatura (°C)', style: { color: '#fff' } },
                    labels: { style: { colors: '#fff' } }
                },
                colors: ['#ff9800'],
                stroke: { curve: 'smooth', width: 3 }
            });

            charts.overview = new ApexCharts(document.querySelector("#overviewChart"), {
                ...chartOptions,
                chart: { ...chartOptions.chart, type: 'line', height: 400, toolbar: { show: true } },
                series: [
                    { name: 'Humedad (%)', data: [] },
                    { name: 'Temperatura (°C)', data: [] }
                ],
                xaxis: {
                    ...chartOptions.xaxis,
                    labels: {
                        format: 'dd/MM HH:mm',
                        style: { colors: '#fff' },
                        datetimeUTC: false
                    }
                },
                yaxis: [
                    {
                        title: { text: 'Humedad (%)', style: { color: '#fff' } },
                        labels: { style: { colors: '#fff' } },
                        min: 0,
                        max: 100
                    },
                    {
                        opposite: true,
                        title: { text: 'Temperatura (°C)', style: { color: '#fff' } },
                        labels: { style: { colors: '#fff' } }
                    }
                ],
                colors: ['#64b5f6', '#ff9800'],
                stroke: { curve: 'smooth', width: 3 },
                legend: { position: 'top', labels: { colors: '#fff' } }
            });

            Object.values(charts).forEach(chart => chart.render());
        }

        function updateCharts() {
            if (dataHistory.length === 0) return;

            const timestamps = dataHistory.map(d => d.timestamp.getTime());
            const humidityData = dataHistory.map((d, i) => [timestamps[i], d.humidity]);
            const temperatureData = dataHistory.map((d, i) => [timestamps[i], d.temperature]);

            charts.humidity.updateSeries([{ data: humidityData }]);
            charts.temperature.updateSeries([{ data: temperatureData }]);
            charts.overview.updateSeries([
                { name: 'Humedad (%)', data: humidityData },
                { name: 'Temperatura (°C)', data: temperatureData }
            ]);
        }

        function loadHistoricalData() {
            fetch('/api/historical-data?hours=24')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        dataHistory = data.reverse().map(item => ({
                            timestamp: convertToEcuadorTime(item.timestamp),
                            humidity: item.humidity,
                            temperature: item.temperature,
                            pump_status: item.pump_status ? 1 : 0
                        }));
                        updateCharts();
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function loadStatistics() {
            fetch('/api/statistics')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('avgHumidity').textContent = data.avg_humidity + '%';
                    document.getElementById('minHumidity').textContent = data.min_humidity + '%';
                    document.getElementById('maxHumidity').textContent = data.max_humidity + '%';
                    document.getElementById('avgTemperature').textContent = data.avg_temperature + '°C';
                    document.getElementById('pumpActivations').textContent = data.pump_activations_24h;
                })
                .catch(error => console.error('Error:', error));
        }

        function loadEvents() {
            fetch('/api/irrigation-events?days=7')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('eventsTableBody');
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">No hay eventos registrados</td></tr>';
                        return;
                    }

                    tbody.innerHTML = data.map(event => {
                        const date = convertToEcuadorTime(event.timestamp);
                        const eventClass = event.event_type === 'INICIO_RIEGO' ? 'event-inicio' : 'event-fin';
                        const eventText = event.event_type === 'INICIO_RIEGO' ? 'Inicio Riego' : 'Fin Riego';
                        
                        // Formatear duración correctamente
                        let durationText = '--';
                        if (event.duration) {
                            const duration = parseFloat(event.duration);
                            if (duration >= 60) {
                                const minutes = Math.floor(duration / 60);
                                const seconds = Math.round(duration % 60);
                                durationText = seconds > 0 ? `${minutes}m ${seconds}s` : `${minutes}m`;
                            } else {
                                durationText = `${Math.round(duration)}s`;
                            }
                        }
                        
                        return `
                            <tr>
                                <td>${formatEcuadorDateTime(event.timestamp)}</td>
                                <td><span class="event-badge ${eventClass}">${eventText}</span></td>
                                <td>${event.humidity_before ? event.humidity_before + '%' : '--'}</td>
                                <td>${event.humidity_after ? event.humidity_after + '%' : '--'}</td>
                                <td>${durationText}</td>
                            </tr>
                        `;
                    }).join('');
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>