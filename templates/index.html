<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioSignal - Dashboard</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.44.0/apexcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        :root {
            /* Modo Oscuro (noche 6pm - 6am) */
            --bg-gradient-dark: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%);
            --card-bg-dark: rgba(255, 255, 255, 0.1);
            --card-border-dark: rgba(255, 255, 255, 0.2);
            --text-primary-dark: #fff;
            --text-secondary-dark: rgba(255, 255, 255, 0.8);
            --text-tertiary-dark: rgba(255, 255, 255, 0.7);
            --accent-color-dark: #64b5f6;
            --grid-color-dark: rgba(255,255,255,0.1);
            --hover-bg-dark: rgba(255, 255, 255, 0.15);
            --status-connected-dark: rgba(76, 175, 80, 0.3);
            --status-disconnected-dark: rgba(244, 67, 54, 0.3);
            
            /* Modo Claro (d√≠a 6am - 6pm) */
            --bg-gradient-light: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            --card-bg-light: rgba(255, 255, 255, 0.9);
            --card-border-light: rgba(0, 0, 0, 0.1);
            --text-primary-light: #1a1a1a;
            --text-secondary-light: #424242;
            --text-tertiary-light: #666666;
            --accent-color-light: #1976d2;
            --grid-color-light: rgba(0,0,0,0.1);
            --hover-bg-light: rgba(255, 255, 255, 0.95);
            --status-connected-light: rgba(76, 175, 80, 0.8);
            --status-disconnected-light: rgba(244, 67, 54, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            transition: all 0.5s ease;
        }

        /* Modo Oscuro por defecto */
        body.dark-mode {
            background: var(--bg-gradient-dark);
            color: var(--text-primary-dark);
        }

        /* Modo Claro */
        body.light-mode {
            background: var(--bg-gradient-light);
            color: var(--text-primary-light);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .dark-mode .header {
            background: var(--card-bg-dark);
            border: 1px solid var(--card-border-dark);
        }

        .light-mode .header {
            background: var(--card-bg-light);
            border: 1px solid var(--card-border-light);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .logo-container {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 2px solid;
        }

        .dark-mode .logo-container {
            background: var(--accent-color-dark);
            color: white;
            border-color: var(--accent-color-dark);
        }

        .light-mode .logo-container {
            background: var(--accent-color-light);
            color: white;
            border-color: var(--accent-color-light);
        }

        .header h1 {
            font-size: 2.5rem;
            margin: 0;
            font-weight: 700;
        }

        .dark-mode .header h1 {
            color: var(--text-primary-dark);
        }

        .light-mode .header h1 {
            color: var(--text-primary-light);
        }

        .header p {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .dark-mode .header p {
            color: var(--text-secondary-dark);
        }

        .light-mode .header p {
            color: var(--text-secondary-light);
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            color: white;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .dark-mode .connection-status {
            background: var(--status-connected-dark);
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .light-mode .connection-status {
            background: var(--status-connected-light);
            border: 1px solid rgba(76, 175, 80, 0.8);
        }

        .connection-status.disconnected.dark-mode {
            background: var(--status-disconnected-dark);
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        .connection-status.disconnected.light-mode {
            background: var(--status-disconnected-light);
            border: 1px solid rgba(244, 67, 54, 0.8);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .status-card {
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .dark-mode .status-card {
            background: var(--card-bg-dark);
            border: 1px solid var(--card-border-dark);
        }

        .light-mode .status-card {
            background: var(--card-bg-light);
            border: 1px solid var(--card-border-light);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .status-card:hover {
            transform: translateY(-5px);
        }
        /* Estilos para la secci√≥n de mensajes de la planta */
.plant-message-section {
    margin-bottom: 30px;
}

.plant-message-card {
    backdrop-filter: blur(10px);
    border-radius: 25px;
    padding: 25px;
    display: flex;
    align-items: center;
    gap: 20px;
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
}

.dark-mode .plant-message-card {
    background: var(--card-bg-dark);
    border: 1px solid var(--card-border-dark);
}

.light-mode .plant-message-card {
    background: var(--card-bg-light);
    border: 1px solid var(--card-border-light);
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.plant-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.dark-mode .plant-avatar {
    background: rgba(76, 175, 80, 0.2);
    border: 2px solid rgba(76, 175, 80, 0.4);
    color: #4CAF50;
}

.light-mode .plant-avatar {
    background: rgba(76, 175, 80, 0.15);
    border: 2px solid rgba(76, 175, 80, 0.3);
    color: #2E7D32;
}

.plant-message-content {
    flex: 1;
}

.plant-name {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.dark-mode .plant-name {
    color: var(--text-secondary-dark);
}

.light-mode .plant-name {
    color: var(--text-secondary-light);
}

.plant-message {
    font-size: 1.3rem;
    font-weight: 500;
    margin-bottom: 10px;
    line-height: 1.4;
}

.dark-mode .plant-message {
    color: var(--text-primary-dark);
}

.light-mode .plant-message {
    color: var(--text-primary-light);
}

.plant-mood {
    font-size: 2.5rem;
    position: absolute;
    right: 25px;
    top: 50%;
    transform: translateY(-50%);
    animation: float 3s ease-in-out infinite;
}

/* Estados de la planta */
.plant-message-card.happy {
    animation: happy-glow 2s ease-in-out infinite alternate;
}

.plant-message-card.watering {
    animation: watering-pulse 1.5s ease-in-out infinite;
}

.plant-message-card.watering .plant-avatar {
    animation: bounce 1s ease-in-out infinite;
}

.plant-message-card.thirsty {
    animation: thirsty-shake 0.5s ease-in-out infinite;
}

.plant-message-card.critical {
    animation: critical-alert 0.8s ease-in-out infinite;
}

.dark-mode .plant-message-card.critical {
    border-color: rgba(244, 67, 54, 0.6);
    background: rgba(244, 67, 54, 0.1);
}

.light-mode .plant-message-card.critical {
    border-color: rgba(244, 67, 54, 0.8);
    background: rgba(244, 67, 54, 0.05);
}

.plant-message-card.critical .plant-avatar {
    background: rgba(244, 67, 54, 0.2) !important;
    border-color: rgba(244, 67, 54, 0.4) !important;
    color: #f44336 !important;
}

/* Animaciones */
@keyframes float {
    0%, 100% { transform: translateY(-50%) rotate(0deg); }
    50% { transform: translateY(-60%) rotate(5deg); }
}

@keyframes happy-glow {
    0% { box-shadow: 0 0 10px rgba(76, 175, 80, 0.3); }
    100% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.5); }
}

@keyframes watering-pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

@keyframes thirsty-shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-2px); }
    75% { transform: translateX(2px); }
}

@keyframes critical-alert {
    0%, 100% { 
        transform: scale(1);
        box-shadow: 0 0 10px rgba(244, 67, 54, 0.3);
    }
    50% { 
        transform: scale(1.01);
        box-shadow: 0 0 25px rgba(244, 67, 54, 0.6);
    }
}

/* Responsive para m√≥viles */
@media (max-width: 768px) {
    .plant-message-card {
        flex-direction: column;
        text-align: center;
        padding: 20px;
    }
    
    .plant-avatar {
        width: 60px;
        height: 60px;
        font-size: 2rem;
    }
    
    .plant-message {
        font-size: 1.1rem;
    }
    
    .plant-mood {
        position: static;
        transform: none;
        margin-top: 10px;
    }
}
        .dark-mode .status-card:hover {
            background: var(--hover-bg-dark);
        }

        .light-mode .status-card:hover {
            background: var(--hover-bg-light);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .status-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .dark-mode .status-icon {
            color: var(--accent-color-dark);
        }

        .light-mode .status-icon {
            color: var(--accent-color-light);
        }

        .status-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .dark-mode .status-value {
            color: var(--text-primary-dark);
        }

        .light-mode .status-value {
            color: var(--text-primary-light);
        }

        .status-label {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .dark-mode .status-label {
            color: var(--text-tertiary-dark);
        }

        .light-mode .status-label {
            color: var(--text-tertiary-light);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            transition: all 0.3s ease;
        }

        .dark-mode .chart-container {
            background: var(--card-bg-dark);
            border: 1px solid var(--card-border-dark);
        }

        .light-mode .chart-container {
            background: var(--card-bg-light);
            border: 1px solid var(--card-border-light);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dark-mode .chart-title {
            color: var(--text-primary-dark);
        }

        .light-mode .chart-title {
            color: var(--text-primary-light);
        }

        .chart-title i {
            transition: all 0.3s ease;
        }

        .dark-mode .chart-title i {
            color: var(--accent-color-dark);
        }

        .light-mode .chart-title i {
            color: var(--accent-color-light);
        }

        .full-width-chart {
            grid-column: 1 / -1;
        }

        .statistics-section, .events-section {
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
.logo-box {
    width: 80px;
    height: 80px; /* cuadrado */
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    transition: all 0.3s ease;
    background-color: transparent; /* fondo transparente */
}

.logo-img {
    width: 100%;
    height: 100%;
    object-fit: contain; /* o cover si prefieres */
    border-radius: 10px; /* opcional */
}

/* Fondo transparente y borde con color de tema */
.dark-mode .logo-box {
    background-color: transparent;
    border-color: var(--accent-color-dark);
    color: white;
}

.light-mode .logo-box {
    background-color: transparent;
    border-color: var(--accent-color-light);
    color: white;
}

        .dark-mode .statistics-section,
        .dark-mode .events-section {
            background: var(--card-bg-dark);
            border: 1px solid var(--card-border-dark);
        }

        .light-mode .statistics-section,
        .light-mode .events-section {
            background: var(--card-bg-light);
            border: 1px solid var(--card-border-light);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .dark-mode .stat-item {
            background: var(--card-bg-dark);
            border: 1px solid var(--card-border-dark);
        }

        .light-mode .stat-item {
            background: var(--card-bg-light);
            border: 1px solid var(--card-border-light);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-item:hover {
            transform: translateY(-3px);
        }

        .dark-mode .stat-item:hover {
            background: var(--hover-bg-dark);
        }

        .light-mode .stat-item:hover {
            background: var(--hover-bg-light);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .dark-mode .stat-value {
            color: var(--accent-color-dark);
        }

        .light-mode .stat-value {
            color: var(--accent-color-light);
        }

        .stat-label {
            font-size: 0.9rem;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dark-mode .stat-label {
            color: var(--text-tertiary-dark);
        }

        .light-mode .stat-label {
            color: var(--text-tertiary-light);
        }

        .events-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .events-table th,
        .events-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid;
            transition: all 0.3s ease;
        }

        .dark-mode .events-table th,
        .dark-mode .events-table td {
            color: var(--text-primary-dark);
            border-bottom-color: var(--card-border-dark);
        }

        .light-mode .events-table th,
        .light-mode .events-table td {
            color: var(--text-primary-light);
            border-bottom-color: var(--card-border-light);
        }

        .events-table th {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }

        .dark-mode .events-table th {
            background: var(--card-bg-dark);
        }

        .light-mode .events-table th {
            background: var(--card-bg-light);
        }

        .events-table tr:hover {
            transition: all 0.3s ease;
        }

        .dark-mode .events-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .light-mode .events-table tr:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .event-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .event-inicio {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .event-fin {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .logo-container {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .status-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
    
</head>
<body class="dark-mode">
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="platform-info">
                    <h1>BioSignal</h1>
                    <p class="platform-description">Monitoreo y Control Inteligente de Cultivos</p>
                    <div class="platform-features">
                        <span class="feature-tag"><i class="fas fa-wifi"></i> IoT Conectado</span>
                        <span class="feature-tag"><i class="fas fa-chart-line"></i> An√°lisis en Tiempo Real</span>
                        <span class="feature-tag"><i class="fas fa-mobile-alt"></i> Control Remoto</span>
                    </div>
                </div>
                <div class="logo-box">
                    <img src="{{ url_for('static', filename='biosignal.png') }}" alt="Logo de BioSignal" class="logo-img">
                </div>
            </div>
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-wifi"></i>
                <span>Conectando...</span>
            </div>
        </div>

        <!-- Secci√≥n de Mensajes de la Planta -->
        <div class="plant-message-section">
            <div class="plant-message-card" id="plantMessageCard">
                <div class="plant-avatar">
                    <i class="fas fa-seedling" id="plantIcon"></i>
                </div>
                <div class="plant-message-content">
                    <div class="plant-name">üå± Mi Planta Dice:</div>
                    <div class="plant-message" id="plantMessage">Conectando con la planta...</div>
                    <div class="plant-mood" id="plantMood">üò¥</div>
                </div>
            </div>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <div class="status-icon"><i class="fas fa-tint"></i></div>
                <div class="status-value" id="humidityValue">--</div>
                <div class="status-label">Humedad del Suelo</div>
            </div>
            
            <div class="status-card">
                <div class="status-icon" id="temperatureIcon"><i class="fas fa-thermometer-half"></i></div>
                <div class="status-value" id="temperatureValue">--</div>
                <div class="status-label">Temperatura</div>
            </div>
            
            <div class="status-card">
                <div class="status-icon"><i class="fas fa-pump-soap"></i></div>
                <div class="status-value" id="pumpStatus">--</div>
                <div class="status-label">Estado de Bomba</div>
            </div>
            
            <div class="status-card">
                <div class="status-icon"><i class="fas fa-cogs"></i></div>
                <div class="status-value" id="systemStatus">--</div>
                <div class="status-label">Estado del Sistema</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-tint"></i>
                    Evoluci√≥n de Humedad del Suelo
                </div>
                <div id="humidityChart"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-thermometer-half" id="chartTemperatureIcon"></i>
                    Evoluci√≥n de Temperatura
                </div>
                <div id="temperatureChart"></div>
            </div>

            <div class="chart-container full-width-chart">
                <div class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    Vista General del Sistema
                </div>
                <div id="overviewChart"></div>
            </div>
        </div>

        <div class="statistics-section">
            <div class="chart-title">
                <i class="fas fa-chart-bar"></i>
                Estad√≠sticas del Sistema
            </div>
            <div class="statistics-grid">
                <div class="stat-item">
                    <div class="stat-value" id="avgHumidity">--</div>
                    <div class="stat-label">Humedad Promedio</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="minHumidity">--</div>
                    <div class="stat-label">Humedad M√≠nima</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="maxHumidity">--</div>
                    <div class="stat-label">Humedad M√°xima</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgTemperature">--</div>
                    <div class="stat-label">Temperatura Promedio</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="pumpActivations">--</div>
                    <div class="stat-label">Activaciones Bomba (24h)</div>
                </div>
            </div>
        </div>

        <div class="events-section">
            <div class="chart-title">
                <i class="fas fa-history"></i>
                Registro de Eventos de Riego BioSignal Pro
            </div>
            <div style="overflow-x: auto;">
                <table class="events-table">
                    <thead>
                        <tr>
                            <th>Fecha y Hora</th>
                            <th>Tipo de Evento</th>
                            <th>Humedad Antes</th>
                            <th>Humedad Despu√©s</th>
                            <th>Duraci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 30px;">
                                Cargando eventos...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
        <script>
        let socket;
        let charts = {};
        let dataHistory = [];
        const MAX_DATA_POINTS = 50;

        // Configurar zona horaria de Ecuador (UTC-5)
        const ECUADOR_TIMEZONE_OFFSET = -5; // UTC-5
        // Funci√≥n para actualizar el mensaje de la planta
function updatePlantMessage(humidity, pumpStatus, systemStatus) {
    const plantMessage = document.getElementById('plantMessage');
    const plantMood = document.getElementById('plantMood');
    const plantIcon = document.getElementById('plantIcon');
    const plantCard = document.getElementById('plantMessageCard');
    
    // Asegurar que tenemos un valor num√©rico de humedad
    const humidityValue = parseFloat(humidity) || 0;
    
    let message = "";
    let mood = "";
    let iconClass = "fas fa-seedling";
    let cardClass = "plant-message-card";
    
    if (pumpStatus === true || pumpStatus === 'ACTIVA') {
        // Durante el riego
        message = "¬°Ahhhh qu√© rico! üíßüòã Mi sistema autom√°tico me est√° regando perfectamente";
        mood = "üòã";
        iconClass = "fas fa-tint";
        cardClass += " watering";
    } else if (humidityValue > 80) {
        // Muy h√∫medo - coincide con LCD "Me ahogo :O"
        message = "¬°Ayyyy me ahogo! üåäüòµ Demasiada agua, pero mi sistema inteligente lo controlar√°";
        mood = "üòµ";
        iconClass = "fas fa-exclamation-triangle";
        cardClass += " drowning";
    } else if (humidityValue > 60) {
        // H√∫medo - coincide con LCD "Muy mojada :|"
        message = "Estoy muy mojada üíßüòê Pero est√° bien, mi sistema sabe lo que hace";
        mood = "üòê";
        iconClass = "fas fa-tint";
        cardClass += " wet";
    } else if (humidityValue > 40) {
        // Humedad buena - coincide con LCD "Estoy feliz :)"
        message = "¬°Estoy s√∫per feliz! üòäüåø Mi nivel de humedad est√° perfecto, gracias BioSignal";
        mood = "üòä";
        iconClass = "fas fa-seedling";
        cardClass += " happy";
    } else if (humidityValue > 30) {
        // Humedad baja - coincide con LCD "Tengo sed :/"
        message = "Tengo un poquito de sed üòïüíß Pero conf√≠o en que mi riego autom√°tico actuar√° pronto";
        mood = "üòï";
        iconClass = "fas fa-seedling";
        cardClass += " thirsty";
    } else if (humidityValue > 15) {
        // Muy seca - coincide con LCD "Agua urgente :("
        message = "¬°Estoy sedienta! üò∞üåµ Esperando que mi sistema autom√°tico detecte que necesito riego";
        mood = "üò∞";
        iconClass = "fas fa-exclamation-triangle";
        cardClass += " urgent";
    } else {
        // Cr√≠tica - coincide con LCD "Me muero D:"
        message = "¬°Situaci√≥n cr√≠tica! üíÄüÜò Mi sistema autom√°tico deber√≠a activarse YA";
        mood = "üòµ";
        iconClass = "fas fa-skull-crossbones";
        cardClass += " critical";
    }
    
    // Mensajes especiales seg√∫n el estado del sistema
    if (systemStatus && systemStatus.includes("ESPERANDO")) {
        if (humidityValue > 70) {
            message = "Todo perfecto por aqu√≠, descansando tranquila üò¥üí§";
            mood = "üò¥";
        }
    }
    
    // Actualizar el DOM
    if (plantMessage) plantMessage.textContent = message;
    if (plantMood) plantMood.textContent = mood;
    if (plantIcon) plantIcon.className = iconClass;
    if (plantCard) plantCard.className = cardClass;
    
    console.log(`Mensaje actualizado - Humedad: ${humidityValue}%, Bomba: ${pumpStatus}, Sistema: ${systemStatus}`);
}

// Funci√≥n para actualizar con los valores actuales de la pantalla
function updatePlantMessageFromCurrentValues() {
    const humidityElement = document.getElementById('humidityValue');
    const pumpElement = document.getElementById('pumpStatus');
    const systemElement = document.getElementById('systemStatus');
    
    if (humidityElement && pumpElement && systemElement) {
        const humidity = parseFloat(humidityElement.textContent.replace('%', ''));
        const pumpStatus = pumpElement.textContent === 'ACTIVA';
        const systemStatus = systemElement.textContent;
        
        console.log(`Leyendo valores actuales - Humedad: ${humidity}%, Bomba: ${pumpStatus}, Sistema: ${systemStatus}`);
        updatePlantMessage(humidity, pumpStatus, systemStatus);
    }
}

// Funci√≥n modificada para actualizar datos en tiempo real
function updateRealTimeData(data) {
    // Actualizar valores en los cards
    document.getElementById('humidityValue').textContent = data.humidity + '%';
    document.getElementById('temperatureValue').textContent = data.temperature + '¬∞C';
    document.getElementById('pumpStatus').textContent = data.pump_status ? 'ACTIVA' : 'INACTIVA';
    document.getElementById('systemStatus').textContent = data.system_status;
    
    // Actualizar el mensaje de la planta con los datos recibidos
    updatePlantMessage(data.humidity, data.pump_status, data.system_status);
    
    // Efecto visual para la bomba
    const pumpCard = document.querySelectorAll('.status-card')[2];
    if (data.pump_status) {
        pumpCard.classList.add('pulse');
    } else {
        pumpCard.classList.remove('pulse');
    }
}

// Funci√≥n para cargar datos hist√≥ricos
function loadHistoricalData() {
    fetch('/api/historical-data?hours=24')
        .then(response => response.json())
        .then(data => {
            if (data.length > 0) {
                dataHistory = data.reverse().map(item => ({
                    timestamp: convertToEcuadorTime(item.timestamp),
                    humidity: item.humidity,
                    temperature: item.temperature,
                    pump_status: item.pump_status ? 1 : 0
                }));
                updateCharts();
                
                // Actualizar el mensaje de la planta con los datos m√°s recientes
                const latestData = dataHistory[dataHistory.length - 1];
                if (latestData) {
                    updatePlantMessage(latestData.humidity, latestData.pump_status === 1, 'SISTEMA_ACTIVO');
                }
            }
        })
        .catch(error => {
            console.error('Error cargando datos hist√≥ricos:', error);
            // Si no hay datos hist√≥ricos, intentar actualizar con valores actuales
            setTimeout(updatePlantMessageFromCurrentValues, 1000);
        });
}

// Agregar al final del DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    // ... tu c√≥digo existente ...
    
    // Actualizar mensaje despu√©s de que todo est√© cargado
    setTimeout(() => {
        updatePlantMessageFromCurrentValues();
        console.log('Intentando actualizar mensaje de la planta con valores actuales');
    }, 2000);
    
    // Tambi√©n verificar cada 5 segundos si el mensaje necesita actualizarse
    setInterval(updatePlantMessageFromCurrentValues, 5000);
});

// Funci√≥n para forzar actualizaci√≥n manual (puedes llamarla desde la consola para testing)
function forceUpdatePlantMessage() {
    updatePlantMessageFromCurrentValues();
}
        // Funci√≥n para obtener la hora actual de Ecuador
        function getEcuadorTime() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const ecuadorTime = new Date(utc + (ECUADOR_TIMEZONE_OFFSET * 3600000));
            return ecuadorTime;
        }

        // Funci√≥n para verificar si es de d√≠a (6am - 6pm) o noche (6pm - 6am)
        function isDayTime() {
            const ecuadorTime = getEcuadorTime();
            const hour = ecuadorTime.getHours();
            return hour >= 6 && hour < 18; // 6:00 AM a 5:59 PM = d√≠a
        }

        // Funci√≥n para actualizar el modo claro/oscuro y los iconos
        function updateThemeAndIcons() {
            const isDay = isDayTime();
            const body = document.body;
            const temperatureIcon = document.getElementById('temperatureIcon');
            const chartTemperatureIcon = document.getElementById('chartTemperatureIcon');
            const connectionStatus = document.getElementById('connectionStatus');
            
            if (isDay) {
                // Modo claro (d√≠a)
                body.className = 'light-mode';
                
                // Icono de sol para temperatura
                temperatureIcon.innerHTML = '<i class="fas fa-sun"></i>';
                chartTemperatureIcon.className = 'fas fa-sun';
            } else {
                // Modo oscuro (noche)
                body.className = 'dark-mode';
                
                // Icono de luna para temperatura
                temperatureIcon.innerHTML = '<i class="fas fa-moon"></i>';
                chartTemperatureIcon.className = 'fas fa-moon';
            }
            
            // Actualizar clases del estado de conexi√≥n
            if (connectionStatus.classList.contains('disconnected')) {
                connectionStatus.className = `connection-status disconnected ${body.className}`;
            } else {
                connectionStatus.className = `connection-status ${body.className}`;
            }
            
            // Actualizar tema de los gr√°ficos
            updateChartsTheme(isDay);
        }

        // Funci√≥n para actualizar el tema de los gr√°ficos
        function updateChartsTheme(isDay) {
            const chartOptions = {
                theme: { mode: isDay ? 'light' : 'dark' },
                chart: {
                    background: 'transparent',
                },
                xaxis: {
                    labels: {
                        style: { colors: isDay ? '#1a1a1a' : '#fff' }
                    }
                },
                yaxis: {
                    labels: {
                        style: { colors: isDay ? '#1a1a1a' : '#fff' }
                    },
                    title: {
                        style: { color: isDay ? '#1a1a1a' : '#fff' }
                    }
                },
                grid: { 
                    borderColor: isDay ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' 
                },
                legend: { 
                    labels: { colors: isDay ? '#1a1a1a' : '#fff' } 
                }
            };

            // Actualizar cada gr√°fico si existe
            Object.values(charts).forEach(chart => {
                if (chart && chart.updateOptions) {
                    chart.updateOptions(chartOptions);
                }
            });
        }

        // Funci√≥n para convertir timestamp UTC a hora local de Ecuador
        function convertToEcuadorTime(timestamp) {
            const date = new Date(timestamp);
            // Si el timestamp ya viene como string, parsearlo primero
            if (typeof timestamp === 'string') {
                // Verificar si ya incluye informaci√≥n de zona horaria
                if (timestamp.includes('Z') || timestamp.includes('+') || timestamp.includes('-')) {
                    return new Date(timestamp);
                } else {
                    // Asumir que es UTC y convertir a hora de Ecuador
                    return new Date(timestamp + 'Z');
                }
            }
            return date;
        }

        // Funci√≥n para formatear fecha en zona horaria de Ecuador
        function formatEcuadorDateTime(timestamp) {
            const date = convertToEcuadorTime(timestamp);
            return date.toLocaleString('es-EC', {
                timeZone: 'America/Guayaquil',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar tema y iconos seg√∫n la hora actual
            updateThemeAndIcons();
            
            // Actualizar tema cada minuto para capturar cambios de hora
            setInterval(updateThemeAndIcons, 60000);
            
            initializeSocket();
            initializeCharts();
            loadHistoricalData();
            loadStatistics();
            loadEvents();
            
            setInterval(() => {
                loadHistoricalData();
                loadStatistics();
                loadEvents();
            }, 30000);
        });

        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                updateConnectionStatus(true, 'Conectado en tiempo real');
            });
            
            socket.on('disconnect', function() {
                updateConnectionStatus(false, 'Desconectado');
            });
            
            socket.on('sensor_data', function(data) {
                updateRealTimeData(data);
                addToDataHistory(data);
                updateCharts();
            });
        }

        function updateConnectionStatus(connected, message) {
            const statusElement = document.getElementById('connectionStatus');
            const currentMode = document.body.className;
            
            if (connected) {
                statusElement.className = `connection-status ${currentMode}`;
            } else {
                statusElement.className = `connection-status disconnected ${currentMode}`;
            }
            
            statusElement.innerHTML = `
                <i class="fas ${connected ? 'fa-wifi' : 'fa-wifi-slash'}"></i>
                <span>${message}</span>
            `;
        }

        function updateRealTimeData(data) {
            document.getElementById('humidityValue').textContent = data.humidity + '%';
            document.getElementById('temperatureValue').textContent = data.temperature + '¬∞C';
            document.getElementById('pumpStatus').textContent = data.pump_status ? 'ACTIVA' : 'INACTIVA';
            document.getElementById('systemStatus').textContent = data.system_status;
            
            const pumpCard = document.querySelectorAll('.status-card')[2];
            if (data.pump_status) {
                pumpCard.classList.add('pulse');
            } else {
                pumpCard.classList.remove('pulse');
            }
        }

        function addToDataHistory(data) {
            dataHistory.push({
                timestamp: convertToEcuadorTime(data.timestamp),
                humidity: data.humidity,
                temperature: data.temperature,
                pump_status: data.pump_status ? 1 : 0
            });
            
            if (dataHistory.length > MAX_DATA_POINTS) {
                dataHistory.shift();
            }
        }

        function initializeCharts() {
            const isDay = isDayTime();
            const textColor = isDay ? '#1a1a1a' : '#fff';
            const gridColor = isDay ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
            
            const chartOptions = {
                chart: {
                    background: 'transparent',
                    toolbar: { show: false },
                    locales: [{
                        name: 'es',
                        options: {
                            months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                            shortMonths: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                            days: ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'],
                            shortDays: ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b']
                        }
                    }],
                    defaultLocale: 'es'
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        format: 'HH:mm',
                        style: { colors: textColor },
                        datetimeUTC: false // Importante: usar hora local
                    }
                },
                grid: { borderColor: gridColor },
                theme: { mode: isDay ? 'light' : 'dark' }
            };

            charts.humidity = new ApexCharts(document.querySelector("#humidityChart"), {
                ...chartOptions,
                chart: { ...chartOptions.chart, type: 'line', height: 350 },
                series: [{ name: 'Humedad (%)', data: [] }],
                yaxis: {
                    title: { text: 'Humedad (%)', style: { color: textColor } },
                    labels: { style: { colors: textColor } },
                    min: 0,
                    max: 100
                },
                colors: [isDay ? '#1976d2' : '#64b5f6'],
                stroke: { curve: 'smooth', width: 3 }
            });

            charts.temperature = new ApexCharts(document.querySelector("#temperatureChart"), {
                ...chartOptions,
                chart: { ...chartOptions.chart, type: 'line', height: 350 },
                series: [{ name: 'Temperatura (¬∞C)', data: [] }],
                yaxis: {
                    title: { text: 'Temperatura (¬∞C)', style: { color: textColor } },
                    labels: { style: { colors: textColor } }
                },
                colors: ['#ff9800'],
                stroke: { curve: 'smooth', width: 3 }
            });

            charts.overview = new ApexCharts(document.querySelector("#overviewChart"), {
                ...chartOptions,
                chart: { ...chartOptions.chart, type: 'line', height: 400, toolbar: { show: true } },
                series: [
                    { name: 'Humedad (%)', data: [] },
                    { name: 'Temperatura (¬∞C)', data: [] }
                ],
                xaxis: {
                    ...chartOptions.xaxis,
                    labels: {
                        format: 'dd/MM HH:mm',
                        style: { colors: textColor },
                        datetimeUTC: false
                    }
                },
                yaxis: [
                    {
                        title: { text: 'Humedad (%)', style: { color: textColor } },
                        labels: { style: { colors: textColor } },
                        min: 0,
                        max: 100
                    },
                    {
                        opposite: true,
                        title: { text: 'Temperatura (¬∞C)', style: { color: textColor } },
                        labels: { style: { colors: textColor } }
                    }
                ],
                colors: [isDay ? '#1976d2' : '#64b5f6', '#ff9800'],
                stroke: { curve: 'smooth', width: 3 },
                legend: { position: 'top', labels: { colors: textColor } }
            });

            Object.values(charts).forEach(chart => chart.render());
        }

        function updateCharts() {
            if (dataHistory.length === 0) return;

            const timestamps = dataHistory.map(d => d.timestamp.getTime());
            const humidityData = dataHistory.map((d, i) => [timestamps[i], d.humidity]);
            const temperatureData = dataHistory.map((d, i) => [timestamps[i], d.temperature]);

            charts.humidity.updateSeries([{ data: humidityData }]);
            charts.temperature.updateSeries([{ data: temperatureData }]);
            charts.overview.updateSeries([
                { name: 'Humedad (%)', data: humidityData },
                { name: 'Temperatura (¬∞C)', data: temperatureData }
            ]);
        }

        function loadHistoricalData() {
            fetch('/api/historical-data?hours=24')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        dataHistory = data.reverse().map(item => ({
                            timestamp: convertToEcuadorTime(item.timestamp),
                            humidity: item.humidity,
                            temperature: item.temperature,
                            pump_status: item.pump_status ? 1 : 0
                        }));
                        updateCharts();
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function loadStatistics() {
            fetch('/api/statistics')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('avgHumidity').textContent = data.avg_humidity + '%';
                    document.getElementById('minHumidity').textContent = data.min_humidity + '%';
                    document.getElementById('maxHumidity').textContent = data.max_humidity + '%';
                    document.getElementById('avgTemperature').textContent = data.avg_temperature + '¬∞C';
                    document.getElementById('pumpActivations').textContent = data.pump_activations_24h;
                })
                .catch(error => console.error('Error:', error));
        }

        function loadEvents() {
            fetch('/api/irrigation-events?days=7')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('eventsTableBody');
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">No hay eventos registrados</td></tr>';
                        return;
                    }

                    tbody.innerHTML = data.map(event => {
                        const date = convertToEcuadorTime(event.timestamp);
                        const eventClass = event.event_type === 'INICIO_RIEGO' ? 'event-inicio' : 'event-fin';
                        const eventText = event.event_type === 'INICIO_RIEGO' ? 'Inicio Riego' : 'Fin Riego';
                        
                        // Formatear duraci√≥n correctamente
                        let durationText = '--';
                        if (event.duration) {
                            const duration = parseFloat(event.duration);
                            if (duration >= 60) {
                                const minutes = Math.floor(duration / 60);
                                const seconds = Math.round(duration % 60);
                                durationText = seconds > 0 ? `${minutes}m ${seconds}s` : `${minutes}m`;
                            } else {
                                durationText = `${Math.round(duration)}s`;
                            }
                        }
                        
                        return `
                            <tr>
                                <td>${formatEcuadorDateTime(event.timestamp)}</td>
                                <td><span class="event-badge ${eventClass}">${eventText}</span></td>
                                <td>${event.humidity_before ? event.humidity_before + '%' : '--'}</td>
                                <td>${event.humidity_after ? event.humidity_after + '%' : '--'}</td>
                                <td>${durationText}</td>
                            </tr>
                        `;
                    }).join('');
                })
                .catch(error => console.error('Error:', error));
        }
        
    </script>
</body>
</html>