<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioSignal - Dashboard</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.44.0/apexcharts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <style>
        :root {
            /* Modo Oscuro (noche 6pm - 6am) */
            --bg-gradient-dark: linear-gradient(135deg, #0d1b2a 0%, #1b263b 100%);
            --card-bg-dark: rgba(255, 255, 255, 0.1);
            --card-border-dark: rgba(255, 255, 255, 0.2);
            --text-primary-dark: #fff;
            --text-secondary-dark: rgba(255, 255, 255, 0.8);
            --text-tertiary-dark: rgba(255, 255, 255, 0.7);
            --accent-color-dark: #64b5f6;
            --grid-color-dark: rgba(255,255,255,0.1);
            --hover-bg-dark: rgba(255, 255, 255, 0.15);
            --status-connected-dark: rgba(76, 175, 80, 0.3);
            --status-disconnected-dark: rgba(244, 67, 54, 0.3);
            
            /* Modo Claro (día 6am - 6pm) */
            --bg-gradient-light: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            --card-bg-light: rgba(255, 255, 255, 0.9);
            --card-border-light: rgba(0, 0, 0, 0.1);
            --text-primary-light: #1a1a1a;
            --text-secondary-light: #424242;
            --text-tertiary-light: #666666;
            --accent-color-light: #1976d2;
            --grid-color-light: rgba(0,0,0,0.1);
            --hover-bg-light: rgba(255, 255, 255, 0.95);
            --status-connected-light: rgba(76, 175, 80, 0.8);
            --status-disconnected-light: rgba(244, 67, 54, 0.8);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            transition: all 0.5s ease;
        }

        /* Modo Oscuro por defecto */
        body.dark-mode {
            background: var(--bg-gradient-dark);
            color: var(--text-primary-dark);
        }

        /* Modo Claro */
        body.light-mode {
            background: var(--bg-gradient-light);
            color: var(--text-primary-light);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .dark-mode .header {
            background: var(--card-bg-dark);
            border: 1px solid var(--card-border-dark);
        }

        .light-mode .header {
            background: var(--card-bg-light);
            border: 1px solid var(--card-border-light);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .logo-container {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            transition: all 0.3s ease;
            border: 2px solid;
        }

        .dark-mode .logo-container {
            background: var(--accent-color-dark);
            color: white;
            border-color: var(--accent-color-dark);
        }

        .light-mode .logo-container {
            background: var(--accent-color-light);
            color: white;
            border-color: var(--accent-color-light);
        }

        .header h1 {
            font-size: 2.5rem;
            margin: 0;
            font-weight: 700;
        }

        .dark-mode .header h1 {
            color: var(--text-primary-dark);
        }

        .light-mode .header h1 {
            color: var(--text-primary-light);
        }

        .header p {
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .dark-mode .header p {
            color: var(--text-secondary-dark);
        }

        .light-mode .header p {
            color: var(--text-secondary-light);
        }

        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            color: white;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .dark-mode .connection-status {
            background: var(--status-connected-dark);
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .light-mode .connection-status {
            background: var(--status-connected-light);
            border: 1px solid rgba(76, 175, 80, 0.8);
        }

        .connection-status.disconnected.dark-mode {
            background: var(--status-disconnected-dark);
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        .connection-status.disconnected.light-mode {
            background: var(--status-disconnected-light);
            border: 1px solid rgba(244, 67, 54, 0.8);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .status-card {
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .dark-mode .status-card {
            background: var(--card-bg-dark);
            border: 1px solid var(--card-border-dark);
        }

        .light-mode .status-card {
            background: var(--card-bg-light);
            border: 1px solid var(--card-border-light);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .status-card:hover {
            transform: translateY(-5px);
        }

        .dark-mode .status-card:hover {
            background: var(--hover-bg-dark);
        }

        .light-mode .status-card:hover {
            background: var(--hover-bg-light);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .status-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }

        .dark-mode .status-icon {
            color: var(--accent-color-dark);
        }

        .light-mode .status-icon {
            color: var(--accent-color-light);
        }

        .status-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .dark-mode .status-value {
            color: var(--text-primary-dark);
        }

        .light-mode .status-value {
            color: var(--text-primary-light);
        }

        .status-label {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .dark-mode .status-label {
            color: var(--text-tertiary-dark);
        }

        .light-mode .status-label {
            color: var(--text-tertiary-light);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            transition: all 0.3s ease;
        }

        .dark-mode .chart-container {
            background: var(--card-bg-dark);
            border: 1px solid var(--card-border-dark);
        }

        .light-mode .chart-container {
            background: var(--card-bg-light);
            border: 1px solid var(--card-border-light);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dark-mode .chart-title {
            color: var(--text-primary-dark);
        }

        .light-mode .chart-title {
            color: var(--text-primary-light);
        }

        .chart-title i {
            transition: all 0.3s ease;
        }

        .dark-mode .chart-title i {
            color: var(--accent-color-dark);
        }

        .light-mode .chart-title i {
            color: var(--accent-color-light);
        }

        .full-width-chart {
            grid-column: 1 / -1;
        }

        .statistics-section, .events-section {
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
.logo-box {
    width: 80px;
    height: 80px; /* cuadrado */
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    transition: all 0.3s ease;
    background-color: transparent; /* fondo transparente */
}

.logo-img {
    width: 100%;
    height: 100%;
    object-fit: contain; /* o cover si prefieres */
    border-radius: 10px; /* opcional */
}

/* Fondo transparente y borde con color de tema */
.dark-mode .logo-box {
    background-color: transparent;
    border-color: var(--accent-color-dark);
    color: white;
}

.light-mode .logo-box {
    background-color: transparent;
    border-color: var(--accent-color-light);
    color: white;
}

        .dark-mode .statistics-section,
        .dark-mode .events-section {
            background: var(--card-bg-dark);
            border: 1px solid var(--card-border-dark);
        }

        .light-mode .statistics-section,
        .light-mode .events-section {
            background: var(--card-bg-light);
            border: 1px solid var(--card-border-light);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            transition: all 0.3s ease;
        }

        .dark-mode .stat-item {
            background: var(--card-bg-dark);
            border: 1px solid var(--card-border-dark);
        }

        .light-mode .stat-item {
            background: var(--card-bg-light);
            border: 1px solid var(--card-border-light);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .stat-item:hover {
            transform: translateY(-3px);
        }

        .dark-mode .stat-item:hover {
            background: var(--hover-bg-dark);
        }

        .light-mode .stat-item:hover {
            background: var(--hover-bg-light);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .dark-mode .stat-value {
            color: var(--accent-color-dark);
        }

        .light-mode .stat-value {
            color: var(--accent-color-light);
        }

        .stat-label {
            font-size: 0.9rem;
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dark-mode .stat-label {
            color: var(--text-tertiary-dark);
        }

        .light-mode .stat-label {
            color: var(--text-tertiary-light);
        }

        .events-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .events-table th,
        .events-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid;
            transition: all 0.3s ease;
        }

        .dark-mode .events-table th,
        .dark-mode .events-table td {
            color: var(--text-primary-dark);
            border-bottom-color: var(--card-border-dark);
        }

        .light-mode .events-table th,
        .light-mode .events-table td {
            color: var(--text-primary-light);
            border-bottom-color: var(--card-border-light);
        }

        .events-table th {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.9rem;
        }

        .dark-mode .events-table th {
            background: var(--card-bg-dark);
        }

        .light-mode .events-table th {
            background: var(--card-bg-light);
        }

        .events-table tr:hover {
            transition: all 0.3s ease;
        }

        .dark-mode .events-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .light-mode .events-table tr:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        .event-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .event-inicio {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.5);
        }

        .event-fin {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
            border: 1px solid rgba(244, 67, 54, 0.5);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            .logo-container {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .status-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body class="dark-mode">
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="logo-box">
    <img src="{{ url_for('static', filename='biosignal.png') }}" alt="Logo de BioSignal" class="logo-img">
</div>

                <div>
                    <h1>BioSignal</h1>
                </div>
            </div>
            <p>Monitoreo y Control Inteligente de Cultivos</p>
            <div class="connection-status" id="connectionStatus">
                <i class="fas fa-wifi"></i>
                <span>Conectando...</span>
            </div>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <div class="status-icon"><i class="fas fa-tint"></i></div>
                <div class="status-value" id="humidityValue">--</div>
                <div class="status-label">Humedad del Suelo</div>
            </div>
            
            <div class="status-card">
                <div class="status-icon" id="temperatureIcon"><i class="fas fa-thermometer-half"></i></div>
                <div class="status-value" id="temperatureValue">--</div>
                <div class="status-label">Temperatura</div>
            </div>
            
            <div class="status-card">
                <div class="status-icon"><i class="fas fa-pump-soap"></i></div>
                <div class="status-value" id="pumpStatus">--</div>
                <div class="status-label">Estado de Bomba</div>
            </div>
            
            <div class="status-card">
                <div class="status-icon"><i class="fas fa-cogs"></i></div>
                <div class="status-value" id="systemStatus">--</div>
                <div class="status-label">Estado del Sistema</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-tint"></i>
                    Evolución de Humedad del Suelo
                </div>
                <div id="humidityChart"></div>
            </div>

            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-thermometer-half" id="chartTemperatureIcon"></i>
                    Evolución de Temperatura
                </div>
                <div id="temperatureChart"></div>
            </div>

            <div class="chart-container full-width-chart">
                <div class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    Vista General del Sistema
                </div>
                <div id="overviewChart"></div>
            </div>
        </div>

        <div class="statistics-section">
            <div class="chart-title">
                <i class="fas fa-chart-bar"></i>
                Estadísticas del Sistema
            </div>
            <div class="statistics-grid">
                <div class="stat-item">
                    <div class="stat-value" id="avgHumidity">--</div>
                    <div class="stat-label">Humedad Promedio</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="minHumidity">--</div>
                    <div class="stat-label">Humedad Mínima</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="maxHumidity">--</div>
                    <div class="stat-label">Humedad Máxima</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="avgTemperature">--</div>
                    <div class="stat-label">Temperatura Promedio</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="pumpActivations">--</div>
                    <div class="stat-label">Activaciones Bomba (24h)</div>
                </div>
            </div>
        </div>

        <div class="events-section">
            <div class="chart-title">
                <i class="fas fa-history"></i>
                Registro de Eventos de Riego BioSignal Pro
            </div>
            <div style="overflow-x: auto;">
                <table class="events-table">
                    <thead>
                        <tr>
                            <th>Fecha y Hora</th>
                            <th>Tipo de Evento</th>
                            <th>Humedad Antes</th>
                            <th>Humedad Después</th>
                            <th>Duración</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 30px;">
                                Cargando eventos...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let socket;
        let charts = {};
        let dataHistory = [];
        const MAX_DATA_POINTS = 50;

        // Configurar zona horaria de Ecuador (UTC-5)
        const ECUADOR_TIMEZONE_OFFSET = -5; // UTC-5

        // Función para obtener la hora actual de Ecuador
        function getEcuadorTime() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const ecuadorTime = new Date(utc + (ECUADOR_TIMEZONE_OFFSET * 3600000));
            return ecuadorTime;
        }

        // Función para verificar si es de día (6am - 6pm) o noche (6pm - 6am)
        function isDayTime() {
            const ecuadorTime = getEcuadorTime();
            const hour = ecuadorTime.getHours();
            return hour >= 6 && hour < 18; // 6:00 AM a 5:59 PM = día
        }

        // Función para actualizar el modo claro/oscuro y los iconos
        function updateThemeAndIcons() {
            const isDay = isDayTime();
            const body = document.body;
            const temperatureIcon = document.getElementById('temperatureIcon');
            const chartTemperatureIcon = document.getElementById('chartTemperatureIcon');
            const connectionStatus = document.getElementById('connectionStatus');
            
            if (isDay) {
                // Modo claro (día)
                body.className = 'light-mode';
                
                // Icono de sol para temperatura
                temperatureIcon.innerHTML = '<i class="fas fa-sun"></i>';
                chartTemperatureIcon.className = 'fas fa-sun';
            } else {
                // Modo oscuro (noche)
                body.className = 'dark-mode';
                
                // Icono de luna para temperatura
                temperatureIcon.innerHTML = '<i class="fas fa-moon"></i>';
                chartTemperatureIcon.className = 'fas fa-moon';
            }
            
            // Actualizar clases del estado de conexión
            if (connectionStatus.classList.contains('disconnected')) {
                connectionStatus.className = `connection-status disconnected ${body.className}`;
            } else {
                connectionStatus.className = `connection-status ${body.className}`;
            }
            
            // Actualizar tema de los gráficos
            updateChartsTheme(isDay);
        }

        // Función para actualizar el tema de los gráficos
        function updateChartsTheme(isDay) {
            const chartOptions = {
                theme: { mode: isDay ? 'light' : 'dark' },
                chart: {
                    background: 'transparent',
                },
                xaxis: {
                    labels: {
                        style: { colors: isDay ? '#1a1a1a' : '#fff' }
                    }
                },
                yaxis: {
                    labels: {
                        style: { colors: isDay ? '#1a1a1a' : '#fff' }
                    },
                    title: {
                        style: { color: isDay ? '#1a1a1a' : '#fff' }
                    }
                },
                grid: { 
                    borderColor: isDay ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)' 
                },
                legend: { 
                    labels: { colors: isDay ? '#1a1a1a' : '#fff' } 
                }
            };

            // Actualizar cada gráfico si existe
            Object.values(charts).forEach(chart => {
                if (chart && chart.updateOptions) {
                    chart.updateOptions(chartOptions);
                }
            });
        }

        // Función para convertir timestamp UTC a hora local de Ecuador
        function convertToEcuadorTime(timestamp) {
            const date = new Date(timestamp);
            // Si el timestamp ya viene como string, parsearlo primero
            if (typeof timestamp === 'string') {
                // Verificar si ya incluye información de zona horaria
                if (timestamp.includes('Z') || timestamp.includes('+') || timestamp.includes('-')) {
                    return new Date(timestamp);
                } else {
                    // Asumir que es UTC y convertir a hora de Ecuador
                    return new Date(timestamp + 'Z');
                }
            }
            return date;
        }

        // Función para formatear fecha en zona horaria de Ecuador
        function formatEcuadorDateTime(timestamp) {
            const date = convertToEcuadorTime(timestamp);
            return date.toLocaleString('es-EC', {
                timeZone: 'America/Guayaquil',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar tema y iconos según la hora actual
            updateThemeAndIcons();
            
            // Actualizar tema cada minuto para capturar cambios de hora
            setInterval(updateThemeAndIcons, 60000);
            
            initializeSocket();
            initializeCharts();
            loadHistoricalData();
            loadStatistics();
            loadEvents();
            
            setInterval(() => {
                loadHistoricalData();
                loadStatistics();
                loadEvents();
            }, 30000);
        });

        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                updateConnectionStatus(true, 'Conectado en tiempo real');
            });
            
            socket.on('disconnect', function() {
                updateConnectionStatus(false, 'Desconectado');
            });
            
            socket.on('sensor_data', function(data) {
                updateRealTimeData(data);
                addToDataHistory(data);
                updateCharts();
            });
        }

        function updateConnectionStatus(connected, message) {
            const statusElement = document.getElementById('connectionStatus');
            const currentMode = document.body.className;
            
            if (connected) {
                statusElement.className = `connection-status ${currentMode}`;
            } else {
                statusElement.className = `connection-status disconnected ${currentMode}`;
            }
            
            statusElement.innerHTML = `
                <i class="fas ${connected ? 'fa-wifi' : 'fa-wifi-slash'}"></i>
                <span>${message}</span>
            `;
        }

        function updateRealTimeData(data) {
            document.getElementById('humidityValue').textContent = data.humidity + '%';
            document.getElementById('temperatureValue').textContent = data.temperature + '°C';
            document.getElementById('pumpStatus').textContent = data.pump_status ? 'ACTIVA' : 'INACTIVA';
            document.getElementById('systemStatus').textContent = data.system_status;
            
            const pumpCard = document.querySelectorAll('.status-card')[2];
            if (data.pump_status) {
                pumpCard.classList.add('pulse');
            } else {
                pumpCard.classList.remove('pulse');
            }
        }

        function addToDataHistory(data) {
            dataHistory.push({
                timestamp: convertToEcuadorTime(data.timestamp),
                humidity: data.humidity,
                temperature: data.temperature,
                pump_status: data.pump_status ? 1 : 0
            });
            
            if (dataHistory.length > MAX_DATA_POINTS) {
                dataHistory.shift();
            }
        }

        function initializeCharts() {
            const isDay = isDayTime();
            const textColor = isDay ? '#1a1a1a' : '#fff';
            const gridColor = isDay ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
            
            const chartOptions = {
                chart: {
                    background: 'transparent',
                    toolbar: { show: false },
                    locales: [{
                        name: 'es',
                        options: {
                            months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'],
                            shortMonths: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
                            days: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
                            shortDays: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb']
                        }
                    }],
                    defaultLocale: 'es'
                },
                xaxis: {
                    type: 'datetime',
                    labels: {
                        format: 'HH:mm',
                        style: { colors: textColor },
                        datetimeUTC: false // Importante: usar hora local
                    }
                },
                grid: { borderColor: gridColor },
                theme: { mode: isDay ? 'light' : 'dark' }
            };

            charts.humidity = new ApexCharts(document.querySelector("#humidityChart"), {
                ...chartOptions,
                chart: { ...chartOptions.chart, type: 'line', height: 350 },
                series: [{ name: 'Humedad (%)', data: [] }],
                yaxis: {
                    title: { text: 'Humedad (%)', style: { color: textColor } },
                    labels: { style: { colors: textColor } },
                    min: 0,
                    max: 100
                },
                colors: [isDay ? '#1976d2' : '#64b5f6'],
                stroke: { curve: 'smooth', width: 3 }
            });

            charts.temperature = new ApexCharts(document.querySelector("#temperatureChart"), {
                ...chartOptions,
                chart: { ...chartOptions.chart, type: 'line', height: 350 },
                series: [{ name: 'Temperatura (°C)', data: [] }],
                yaxis: {
                    title: { text: 'Temperatura (°C)', style: { color: textColor } },
                    labels: { style: { colors: textColor } }
                },
                colors: ['#ff9800'],
                stroke: { curve: 'smooth', width: 3 }
            });

            charts.overview = new ApexCharts(document.querySelector("#overviewChart"), {
                ...chartOptions,
                chart: { ...chartOptions.chart, type: 'line', height: 400, toolbar: { show: true } },
                series: [
                    { name: 'Humedad (%)', data: [] },
                    { name: 'Temperatura (°C)', data: [] }
                ],
                xaxis: {
                    ...chartOptions.xaxis,
                    labels: {
                        format: 'dd/MM HH:mm',
                        style: { colors: textColor },
                        datetimeUTC: false
                    }
                },
                yaxis: [
                    {
                        title: { text: 'Humedad (%)', style: { color: textColor } },
                        labels: { style: { colors: textColor } },
                        min: 0,
                        max: 100
                    },
                    {
                        opposite: true,
                        title: { text: 'Temperatura (°C)', style: { color: textColor } },
                        labels: { style: { colors: textColor } }
                    }
                ],
                colors: [isDay ? '#1976d2' : '#64b5f6', '#ff9800'],
                stroke: { curve: 'smooth', width: 3 },
                legend: { position: 'top', labels: { colors: textColor } }
            });

            Object.values(charts).forEach(chart => chart.render());
        }

        function updateCharts() {
            if (dataHistory.length === 0) return;

            const timestamps = dataHistory.map(d => d.timestamp.getTime());
            const humidityData = dataHistory.map((d, i) => [timestamps[i], d.humidity]);
            const temperatureData = dataHistory.map((d, i) => [timestamps[i], d.temperature]);

            charts.humidity.updateSeries([{ data: humidityData }]);
            charts.temperature.updateSeries([{ data: temperatureData }]);
            charts.overview.updateSeries([
                { name: 'Humedad (%)', data: humidityData },
                { name: 'Temperatura (°C)', data: temperatureData }
            ]);
        }

        function loadHistoricalData() {
            fetch('/api/historical-data?hours=24')
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        dataHistory = data.reverse().map(item => ({
                            timestamp: convertToEcuadorTime(item.timestamp),
                            humidity: item.humidity,
                            temperature: item.temperature,
                            pump_status: item.pump_status ? 1 : 0
                        }));
                        updateCharts();
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        function loadStatistics() {
            fetch('/api/statistics')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('avgHumidity').textContent = data.avg_humidity + '%';
                    document.getElementById('minHumidity').textContent = data.min_humidity + '%';
                    document.getElementById('maxHumidity').textContent = data.max_humidity + '%';
                    document.getElementById('avgTemperature').textContent = data.avg_temperature + '°C';
                    document.getElementById('pumpActivations').textContent = data.pump_activations_24h;
                })
                .catch(error => console.error('Error:', error));
        }

        function loadEvents() {
            fetch('/api/irrigation-events?days=7')
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('eventsTableBody');
                    if (data.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 30px;">No hay eventos registrados</td></tr>';
                        return;
                    }

                    tbody.innerHTML = data.map(event => {
                        const date = convertToEcuadorTime(event.timestamp);
                        const eventClass = event.event_type === 'INICIO_RIEGO' ? 'event-inicio' : 'event-fin';
                        const eventText = event.event_type === 'INICIO_RIEGO' ? 'Inicio Riego' : 'Fin Riego';
                        
                        // Formatear duración correctamente
                        let durationText = '--';
                        if (event.duration) {
                            const duration = parseFloat(event.duration);
                            if (duration >= 60) {
                                const minutes = Math.floor(duration / 60);
                                const seconds = Math.round(duration % 60);
                                durationText = seconds > 0 ? `${minutes}m ${seconds}s` : `${minutes}m`;
                            } else {
                                durationText = `${Math.round(duration)}s`;
                            }
                        }
                        
                        return `
                            <tr>
                                <td>${formatEcuadorDateTime(event.timestamp)}</td>
                                <td><span class="event-badge ${eventClass}">${eventText}</span></td>
                                <td>${event.humidity_before ? event.humidity_before + '%' : '--'}</td>
                                <td>${event.humidity_after ? event.humidity_after + '%' : '--'}</td>
                                <td>${durationText}</td>
                            </tr>
                        `;
                    }).join('');
                })
                .catch(error => console.error('Error:', error));
        }
    </script>
</body>
</html>